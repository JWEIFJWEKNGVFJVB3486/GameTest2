<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>BrickBugs Multiplayer</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background: #222;
        color: white;
      }
      canvas {
        display: block;
      }
      #chatInput {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        padding: 10px;
        font-size: 16px;
        z-index: 10;
        border-radius: 8px;
        border: none;
      }
      #leaderboard {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.6);
        padding: 10px;
        border-radius: 8px;
        z-index: 10;
      }
      .chat-bubble {
        position: absolute;
        background: white;
        color: black;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        white-space: nowrap;
        transform: translate(-50%, -100%);
        pointer-events: none;
      }
      #joystickWrapper {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 120px;
        height: 120px;
        z-index: 10;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
  </head>
  <body>
    <canvas id="gameCanvas" width="1920" height="1080" aria-label="Multiplayer Game Canvas"></canvas>
    <input type="text" id="chatInput" placeholder="Type to chat..." aria-label="Chat input"/>
    <div id="leaderboard" role="region" aria-label="Leaderboard"></div>
    <div id="joystickWrapper"></div>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        remove,
        onDisconnect,
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

 const firebaseConfig = {
  apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
  authDomain: "gametest2-ba5fe.firebaseapp.com",
  databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com",
  projectId: "gametest2-ba5fe",
  storageBucket: "gametest2-ba5fe.firebasestorage.app",
  messagingSenderId: "1063979387642",
  appId: "1:1063979387642:web:307e4621ae0394bcb49743",
  measurementId: "G-394Y1PYWV7"
};

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      let localPlayerId = localStorage.getItem("playerId") || Math.random().toString(36).substring(2, 10);
      localStorage.setItem("playerId", localPlayerId);
      let username = localStorage.getItem("username") || "Guest" + Math.floor(Math.random() * 1000);
      localStorage.setItem("username", username);

      const playersRef = ref(db, "players");
      const playerRef = ref(db, `players/${localPlayerId}`);

      const player = {
        x: 100 + Math.random() * 400,
        y: 100 + Math.random() * 400,
        color: "#" + Math.floor(Math.random() * 16777215).toString(16),
        username: username,
        chat: "",
        hat: "none",
      };

      set(playerRef, player);
      onDisconnect(playerRef).remove();

      const players = {};
      onValue(playersRef, (snapshot) => {
        const data = snapshot.val();
        for (const id in data) {
          players[id] = data[id];
        }
      });

      const keys = {};
      document.addEventListener("keydown", (e) => (keys[e.key.toLowerCase()] = true));
      document.addEventListener("keyup", (e) => (keys[e.key.toLowerCase()] = false));

      const joystickZone = document.getElementById("joystickWrapper");
      let joystick = nipplejs.create({
        zone: joystickZone,
        mode: 'static',
        position: { left: '60px', bottom: '60px' },
        color: 'blue',
      });

      joystick.on('move', (evt, data) => {
        if (!data || !data.angle) return;
        const angle = data.angle.degree;
        keys["arrowup"] = keys["arrowdown"] = keys["arrowleft"] = keys["arrowright"] = false;
        if (angle >= 45 && angle < 135) keys["arrowdown"] = true;
        else if (angle >= 135 && angle < 225) keys["arrowleft"] = true;
        else if (angle >= 225 && angle < 315) keys["arrowup"] = true;
        else keys["arrowright"] = true;
      });

      joystick.on('end', () => {
        keys["arrowup"] = keys["arrowdown"] = keys["arrowleft"] = keys["arrowright"] = false;
      });

      const chatInput = document.getElementById("chatInput");
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && chatInput.value.trim() !== "") {
          player.chat = chatInput.value.trim();
          set(playerRef, player);
          setTimeout(() => {
            player.chat = "";
            set(playerRef, player);
          }, 3000);
          chatInput.value = "";
        }
      });

      function update() {
        const speed = 2;
        if (keys["arrowup"] || keys["w"]) player.y -= speed;
        if (keys["arrowdown"] || keys["s"]) player.y += speed;
        if (keys["arrowleft"] || keys["a"]) player.x -= speed;
        if (keys["arrowright"] || keys["d"]) player.x += speed;
        set(playerRef, player);
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const id in players) {
          const p = players[id];
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, 40, 40);
          ctx.fillStyle = "white";
          ctx.font = "14px Arial";
          ctx.textAlign = "center";
          ctx.fillText(p.username, p.x + 20, p.y - 10);
          if (p.chat) {
            ctx.fillStyle = "white";
            ctx.fillText(p.chat, p.x + 20, p.y - 25);
          }
        }
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
