<!DOCTYPE html>
<html>
<head>
  <title>Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: "Comic Sans MS", cursive, sans-serif;
    }

    canvas {
      display: block;
      background: #eef;
    }

    #leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      font-size: 14px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #chatInput {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-family: "Comic Sans MS", cursive, sans-serif;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="leaderboard"><strong>Players</strong><br><ul id="board"></ul></div>
  <input id="chatInput" placeholder="Type your message..." maxlength="50" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
      authDomain: "gametest2-ba5fe.firebaseapp.com",
      projectId: "gametest2-ba5fe",
      storageBucket: "gametest2-ba5fe.appspot.com",
      messagingSenderId: "1063979387642",
      appId: "1:1063979387642:web:307e4621ae0394bcb49743",
      measurementId: "G-394Y1PYWV7",
      databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const realtimeDb = getDatabase(app);

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const board = document.getElementById("board");
    const chatInput = document.getElementById("chatInput");

    // Fullscreen canvas
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    let player = null;
    let playerRef = null;
    let players = {};

    // Draw all players
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const uid in players) {
        const p = players[uid];
        ctx.fillStyle = p.color || "#000";
        ctx.fillRect(p.x - 10, p.y - 10, 20, 20);

        // Username
        ctx.fillStyle = "black";
        ctx.font = "14px Comic Sans MS";
        ctx.fillText(p.username || "?", p.x - 10, p.y - 15);

        // Speech bubble
        if (p.chat) {
          ctx.fillStyle = "white";
          ctx.strokeStyle = "black";
          ctx.font = "12px Comic Sans MS";
          const textWidth = ctx.measureText(p.chat).width;
          ctx.fillRect(p.x - textWidth / 2 - 5, p.y - 35, textWidth + 10, 18);
          ctx.strokeRect(p.x - textWidth / 2 - 5, p.y - 35, textWidth + 10, 18);
          ctx.fillStyle = "black";
          ctx.fillText(p.chat, p.x - textWidth / 2, p.y - 22);
        }
      }
    }

    function updateLeaderboard() {
      board.innerHTML = "";
      for (const uid in players) {
        const p = players[uid];
        const li = document.createElement("li");
        li.textContent = p.username || "?";
        board.appendChild(li);
      }
    }

    function loop() {
      if (!player) return;
      let moved = false;
      if (keys["w"]) { player.y -= 2; moved = true; }
      if (keys["s"]) { player.y += 2; moved = true; }
      if (keys["a"]) { player.x -= 2; moved = true; }
      if (keys["d"]) { player.x += 2; moved = true; }
      if (moved) {
        set(playerRef, player);
      }
      draw();
      updateLeaderboard();
      requestAnimationFrame(loop);
    }

    const keys = {};
    window.addEventListener("keydown", e => {
      keys[e.key.toLowerCase()] = true;
      if (e.key === "Enter") {
        if (chatInput.style.display === "none") {
          chatInput.style.display = "block";
          chatInput.focus();
        } else {
          const msg = chatInput.value.trim();
          if (msg) {
            player.chat = msg;
            set(playerRef, player);
            setTimeout(() => {
              if (player && player.chat === msg) {
                delete player.chat;
                set(playerRef, player);
              }
            }, 4000); // Clear after 4s
          }
          chatInput.value = "";
          chatInput.style.display = "none";
        }
      }
    });
    window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";
      const uid = user.uid;
      const userDoc = await getDoc(doc(firestore, "users", uid));
      const username = userDoc.exists() ? userDoc.data().username || "Unnamed" : "Guest";

      player = {
        username,
        x: Math.random() * (canvas.width - 100) + 50,
        y: Math.random() * (canvas.height - 100) + 50,
        color: "#" + Math.floor(Math.random() * 16777215).toString(16)
      };

      playerRef = ref(realtimeDb, "players/" + uid);
      set(playerRef, player);
      onDisconnect(playerRef).remove();

      onValue(ref(realtimeDb, "players"), (snapshot) => {
        players = snapshot.val() || {};
      });

      loop();
    });
  </script>
</body>
</html>
