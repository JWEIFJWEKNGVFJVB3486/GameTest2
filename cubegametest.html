<!DOCTYPE html>
<html>
<head>
  <title>3D Cube Multiplayer</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: "Comic Sans MS", cursive; }
    #leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      font-size: 14px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #chatInput {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-family: "Comic Sans MS", cursive;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="leaderboard"><strong>Players</strong><br><ul id="board"></ul></div>
  <input id="chatInput" placeholder="Type your message..." maxlength="50" />

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.176.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.176.0/examples/jsm/controls/OrbitControls.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
      authDomain: "gametest2-ba5fe.firebaseapp.com",
      projectId: "gametest2-ba5fe",
      storageBucket: "gametest2-ba5fe.appspot.com",
      messagingSenderId: "1063979387642",
      appId: "1:1063979387642:web:307e4621ae0394bcb49743",
      measurementId: "G-394Y1PYWV7",
      databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const realtimeDb = getDatabase(app);

    const leaderboard = document.getElementById("board");
    const chatInput = document.getElementById("chatInput");

    // THREE.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    camera.position.set(0, 30, 50);
    controls.update();

    // Light and ground
    scene.add(new THREE.AmbientLight(0xffffff));
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(500, 500),
      new THREE.MeshBasicMaterial({ color: 0xa0a0a0 })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // Store player objects
    const playerMeshes = {};
    let localPlayer = null;
    let playerRef = null;
    let players = {};

    // Resize handler
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function createPlayerMesh(color, username) {
      const group = new THREE.Group();

      const body = new THREE.Mesh(
        new THREE.BoxGeometry(2, 4, 2),
        new THREE.MeshStandardMaterial({ color })
      );
      body.position.y = 2;
      group.add(body);

      const nameTag = createTextSprite(username);
      nameTag.position.y = 6;
      group.add(nameTag);

      return group;
    }

    function createTextSprite(message) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.font = '20px Comic Sans MS';
      canvas.width = ctx.measureText(message).width + 20;
      canvas.height = 30;
      ctx.font = '20px Comic Sans MS';
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black';
      ctx.fillText(message, 10, 20);
      const texture = new THREE.CanvasTexture(canvas);
      const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
      const sprite = new THREE.Sprite(spriteMaterial);
      sprite.scale.set(canvas.width / 10, canvas.height / 10, 1);
      return sprite;
    }

    function updatePlayers() {
      for (const uid in players) {
        const p = players[uid];
        if (!playerMeshes[uid]) {
          const mesh = createPlayerMesh(p.color || "#000", p.username || "?");
          scene.add(mesh);
          playerMeshes[uid] = mesh;
        }
        const mesh = playerMeshes[uid];
        mesh.position.set(p.x, 0, p.y);

        // Update speech bubble
        mesh.children = mesh.children.filter(child => child.type !== 'Sprite' || child.userData.type !== 'chat');
        if (p.chat) {
          const bubble = createTextSprite(p.chat);
          bubble.position.y = 8;
          bubble.userData.type = 'chat';
          mesh.add(bubble);
        }
      }

      // Remove disconnected players
      for (const uid in playerMeshes) {
        if (!players[uid]) {
          scene.remove(playerMeshes[uid]);
          delete playerMeshes[uid];
        }
      }

      // Update leaderboard
      leaderboard.innerHTML = "";
      for (const uid in players) {
        const li = document.createElement("li");
        li.textContent = players[uid].username || "?";
        leaderboard.appendChild(li);
      }
    }

    const keys = {};
    window.addEventListener("keydown", e => {
      keys[e.key.toLowerCase()] = true;

      if (e.key === "Enter") {
        if (chatInput.style.display === "none") {
          chatInput.style.display = "block";
          chatInput.focus();
        } else {
          const msg = chatInput.value.trim();
          if (msg) {
            localPlayer.chat = msg;
            set(playerRef, localPlayer);
            setTimeout(() => {
              if (localPlayer && localPlayer.chat === msg) {
                delete localPlayer.chat;
                set(playerRef, localPlayer);
              }
            }, 4000);
          }
          chatInput.value = "";
          chatInput.style.display = "none";
        }
      }
    });

    window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    function animate() {
      if (localPlayer) {
        let moved = false;
        if (keys["w"]) { localPlayer.y -= 0.2; moved = true; }
        if (keys["s"]) { localPlayer.y += 0.2; moved = true; }
        if (keys["a"]) { localPlayer.x -= 0.2; moved = true; }
        if (keys["d"]) { localPlayer.x += 0.2; moved = true; }
        if (moved) set(playerRef, localPlayer);
      }

      updatePlayers();
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";
      const uid = user.uid;
      const userDoc = await getDoc(doc(firestore, "users", uid));
      const username = userDoc.exists() ? userDoc.data().username || "Unnamed" : "Guest";

      localPlayer = {
        username,
        x: Math.random() * 50 - 25,
        y: Math.random() * 50 - 25,
        color: "#" + Math.floor(Math.random() * 16777215).toString(16)
      };

      playerRef = ref(realtimeDb, "players/" + uid);
      set(playerRef, localPlayer);
      onDisconnect(playerRef).remove();

      onValue(ref(realtimeDb, "players"), (snapshot) => {
        players = snapshot.val() || {};
      });

      animate();
    });
  </script>
</body>
</html>
