<!DOCTYPE html>
<html>
<head>
  <title>3D Roblox-Style Multiplayer</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: "Comic Sans MS", cursive, sans-serif; }
    #leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      font-size: 14px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #chatInput {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-family: "Comic Sans MS", cursive, sans-serif;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      display: none;
    }
  </style>
</head>
<body>
  <div id="leaderboard"><strong>Players</strong><br><ul id="board"></ul></div>
  <input id="chatInput" placeholder="Type your message..." maxlength="50" />

  <script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three';
    import { OrbitControls } from 'https://cdn.skypack.dev/three/examples/jsm/controls/OrbitControls';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
      authDomain: "gametest2-ba5fe.firebaseapp.com",
      projectId: "gametest2-ba5fe",
      storageBucket: "gametest2-ba5fe.appspot.com",
      messagingSenderId: "1063979387642",
      appId: "1:1063979387642:web:307e4621ae0394bcb49743",
      measurementId: "G-394Y1PYWV7",
      databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const realtimeDb = getDatabase(app);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    controls.enableZoom = false;

    camera.position.set(0, 30, 50);
    controls.update();

    const ambientLight = new THREE.AmbientLight(0xffffff, 1);
    scene.add(ambientLight);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(1000, 1000),
      new THREE.MeshStandardMaterial({ color: 0xaaddff })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    const board = document.getElementById("board");
    const chatInput = document.getElementById("chatInput");

    const keys = {};
    const avatars = {};
    let player = null;
    let playerRef = null;
    let uid = null;

    function createAvatar(username, color) {
      const group = new THREE.Group();

      const torso = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 2), new THREE.MeshStandardMaterial({ color }));
      const head = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 3), new THREE.MeshStandardMaterial({ color: 0xffff00 }));
      head.position.y = 6;
      group.add(torso);
      group.add(head);

      const nameDiv = document.createElement('div');
      nameDiv.style.position = 'absolute';
      nameDiv.style.color = 'black';
      nameDiv.style.fontFamily = 'Comic Sans MS';
      nameDiv.innerText = username;
      document.body.appendChild(nameDiv);

      return { group, nameDiv };
    }

    function updateLeaderboard(players) {
      board.innerHTML = "";
      for (const id in players) {
        const li = document.createElement("li");
        li.textContent = players[id].username || "?";
        board.appendChild(li);
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      if (player && playerRef) {
        let moved = false;
        if (keys['w']) { player.y += 0.3; moved = true; }
        if (keys['s']) { player.y -= 0.3; moved = true; }
        if (keys['a']) { player.x -= 0.3; moved = true; }
        if (keys['d']) { player.x += 0.3; moved = true; }
        if (moved) set(playerRef, player);
      }

      for (const id in avatars) {
        const a = avatars[id];
        if (a.group && playerData[id]) {
          a.group.position.set(playerData[id].x, 3, playerData[id].y);
          const pos = a.group.position.clone().project(camera);
          const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
          const y = (-pos.y * 0.5 + 0.5) * window.innerHeight;
          a.nameDiv.style.left = `${x}px`;
          a.nameDiv.style.top = `${y - 30}px`;
        }
      }

      renderer.render(scene, camera);
    }

    window.addEventListener("keydown", e => {
      keys[e.key.toLowerCase()] = true;
      if (e.key === "Enter") {
        if (chatInput.style.display === "none") {
          chatInput.style.display = "block";
          chatInput.focus();
        } else {
          const msg = chatInput.value.trim();
          if (msg) {
            player.chat = msg;
            set(playerRef, player);
            setTimeout(() => {
              if (player && player.chat === msg) {
                delete player.chat;
                set(playerRef, player);
              }
            }, 4000);
          }
          chatInput.value = "";
          chatInput.style.display = "none";
        }
      }
    });
    window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    const playerData = {};

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";
      uid = user.uid;
      const userDoc = await getDoc(doc(firestore, "users", uid));
      const username = userDoc.exists() ? userDoc.data().username || "Unnamed" : "Guest";
      const color = Math.random() * 0xffffff;

      player = { username, x: Math.random() * 100 - 50, y: Math.random() * 100 - 50, color };
      playerRef = ref(realtimeDb, "players/" + uid);
      set(playerRef, player);
      onDisconnect(playerRef).remove();

      onValue(ref(realtimeDb, "players"), (snapshot) => {
        const players = snapshot.val() || {};
        updateLeaderboard(players);

        for (const id in players) {
          playerData[id] = players[id];
          if (!avatars[id]) {
            const { group, nameDiv } = createAvatar(players[id].username, players[id].color);
            avatars[id] = { group, nameDiv };
            scene.add(group);
          }
        }

        for (const id in avatars) {
          if (!players[id]) {
            scene.remove(avatars[id].group);
            document.body.removeChild(avatars[id].nameDiv);
            delete avatars[id];
            delete playerData[id];
          }
        }
      });

      animate();
    });
  </script>
</body>
</html>
