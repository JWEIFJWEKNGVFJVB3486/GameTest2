<!DOCTYPE html>
<html>
<head>
  <title>Studio - Edit Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #e3e3e3;
      user-select: none;
    }
    #toolbar {
      background: #c3c3c3;
      padding: 10px;
      border-bottom: 1px solid #999;
    }
    #toolbar button {
      margin-right: 10px;
      font-weight: bold;
    }
    #canvas {
      position: relative;
      width: 100%;
      height: calc(100vh - 50px);
      background: #ddd;
      overflow: hidden;
      cursor: default;
    }
    /* Common item styles */
    .item {
      position: absolute;
      cursor: move;
      user-select: none;
      box-sizing: border-box;
    }
    .resizer {
      width: 12px;
      height: 12px;
      background: #1c5980;
      position: absolute;
      right: 0;
      bottom: 0;
      cursor: se-resize;
      border-radius: 2px;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="toolbar">
  <button data-type="square">Add Square</button>
  <button data-type="circle">Add Circle</button>
  <button data-type="text">Add Text</button>
  <button id="saveBtn">Save</button>
  <button id="backBtn">Back to Create Game</button>
</div>

<div id="canvas"></div>
<input type="color" id="colorPicker" />
<input type="text" id="textInput" style="position:absolute; display:none; z-index:1000;" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
    authDomain: "gametest2-ba5fe.firebaseapp.com",
    databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com",
    projectId: "gametest2-ba5fe",
    storageBucket: "gametest2-ba5fe.appspot.com",
    messagingSenderId: "1063979387642",
    appId: "1:1063979387642:web:307e4621ae0394bcb49743",
    measurementId: "G-394Y1PYWV7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const canvas = document.getElementById("canvas");
  const saveBtn = document.getElementById("saveBtn");
  const backBtn = document.getElementById("backBtn");
  const colorPicker = document.getElementById("colorPicker");
  const textInput = document.getElementById("textInput");

  const urlParams = new URLSearchParams(window.location.search);
  const gameId = urlParams.get("gameId");

  let unsavedChanges = false;
  let selectedItem = null;

  // Add shape buttons - delegate event listener for multiple buttons
  document.getElementById("toolbar").addEventListener("click", e => {
    if (e.target.tagName === "BUTTON" && e.target.dataset.type) {
      const type = e.target.dataset.type;
      addItem(type);
    }
  });

  saveBtn.addEventListener("click", async () => {
    const items = Array.from(document.querySelectorAll(".item")).map(el => {
      const type = el.dataset.type;
      const base = {
        type,
        x: parseInt(el.style.left),
        y: parseInt(el.style.top),
        width: parseInt(el.style.width),
        height: parseInt(el.style.height),
        zIndex: el.style.zIndex || "auto",
      };

      // Add type-specific properties
      if (type === "text") {
        base.text = el.textContent;
        base.color = el.style.color;
        base.fontSize = el.style.fontSize;
      } else {
        base.color = el.style.backgroundColor;
        base.borderRadius = el.style.borderRadius || "0";
      }

      return base;
    });

    const ref = doc(db, "games", gameId);
    await updateDoc(ref, { items });
    unsavedChanges = false;
    alert("Game saved!");
  });

  backBtn.addEventListener("click", () => {
    if (unsavedChanges && !confirm("You have unsaved changes. Leave anyway?")) return;
    window.location.href = "create-game.html";
  });

  // Main function to create an item of a certain type
  function addItem(type, x = 50, y = 50, width = 100, height = 100, props = {}) {
    let el;

    if (type === "text") {
      el = document.createElement("div");
      el.textContent = props.text || "Text here";
      el.style.color = props.color || "#000";
      el.style.fontSize = props.fontSize || "16px";
      el.style.lineHeight = "1.2";
      el.style.whiteSpace = "pre-wrap";
      el.style.padding = "5px";
      el.style.background = "transparent";
      el.style.border = "1px dashed #888";
      el.style.userSelect = "text";
      el.style.cursor = "text";
      el.style.borderRadius = "2px";
    } else {
      el = document.createElement("div");
      el.style.backgroundColor = props.color || "#3498db";
      el.style.borderRadius = (props.borderRadius !== undefined ? props.borderRadius : (type === "circle" ? "50%" : "2px"));
    }

    el.classList.add("item");
    el.dataset.type = type;

    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.width = width + "px";
    el.style.height = height + "px";
    el.style.position = "absolute";

    // z-index to keep resizers on top if needed
    el.style.zIndex = props.zIndex || "auto";

    if (type !== "text") {
      makeDraggable(el);
      addResizer(el);
      // clicking shape shows color picker
      el.addEventListener("click", e => {
        e.stopPropagation();
        selectedItem = el;
        colorPicker.style.display = "block";
        const rect = el.getBoundingClientRect();
        colorPicker.style.left = rect.right + 5 + "px";
        colorPicker.style.top = rect.top + "px";
        colorPicker.value = rgbToHex(el.style.backgroundColor);
        textInput.style.display = "none";
      });
    } else {
      // Text item editable on double click
      el.addEventListener("dblclick", e => {
        e.stopPropagation();
        selectedItem = el;
        textInput.value = el.textContent;
        const rect = el.getBoundingClientRect();
        textInput.style.left = rect.left + "px";
        textInput.style.top = rect.top + "px";
        textInput.style.width = rect.width + "px";
        textInput.style.height = rect.height + "px";
        textInput.style.fontSize = window.getComputedStyle(el).fontSize;
        textInput.style.display = "block";
        colorPicker.style.display = "none";
        textInput.focus();
      });
      makeDraggable(el);
      addResizer(el);
    }

    canvas.appendChild(el);
    unsavedChanges = true;
  }

  // Update text on input blur or enter
  textInput.addEventListener("blur", () => {
    if (selectedItem && selectedItem.dataset.type === "text") {
      selectedItem.textContent = textInput.value;
      unsavedChanges = true;
    }
    textInput.style.display = "none";
  });
  textInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      textInput.blur();
    }
  });

  // Color picker changes background or color depending on type
  colorPicker.addEventListener("input", () => {
    if (!selectedItem) return;
    if (selectedItem.dataset.type === "text") {
      selectedItem.style.color = colorPicker.value;
    } else {
      selectedItem.style.backgroundColor = colorPicker.value;
    }
    unsavedChanges = true;
  });

  // Helpers:

  function makeDraggable(el) {
    let dragging = false, startX, startY, origX, origY;

    el.addEventListener("mousedown", e => {
      if (e.target.classList.contains("resizer")) return;
      dragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = parseInt(el.style.left);
      origY = parseInt(el.style.top);
      document.body.style.userSelect = "none";
    });

    window.addEventListener("mousemove", e => {
      if (!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      el.style.left = origX + dx + "px";
      el.style.top = origY + dy + "px";
      unsavedChanges = true;
    });

    window.addEventListener("mouseup", () => {
      dragging = false;
      document.body.style.userSelect = "";
    });
  }

  function addResizer(el) {
    const resizer = document.createElement("div");
    resizer.classList.add("resizer");
    el.appendChild(resizer);

    let resizing = false, startX, startY, startWidth, startHeight;

    resizer.addEventListener("mousedown", e => {
      e.stopPropagation();
      resizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = parseInt(window.getComputedStyle(el).width, 10);
      startHeight = parseInt(window.getComputedStyle(el).height, 10);
      document.body.style.userSelect = "none";
    });

    window.addEventListener("mousemove", e => {
      if (!resizing) return;
      let newWidth = startWidth + (e.clientX - startX);
      let newHeight = startHeight + (e.clientY - startY);

      // Enforce minimum size
      newWidth = Math.max(newWidth, 20);
      newHeight = Math.max(newHeight, 20);

      el.style.width = newWidth + "px";
      el.style.height = newHeight + "px";

      unsavedChanges = true;
    });

    window.addEventListener("mouseup", () => {
      resizing = false;
      document.body.style.userSelect = "";
    });
  }

  // Convert rgb(51, 51, 255) -> #3333ff for color picker compatibility
  function rgbToHex(rgb) {
    if (!rgb) return "#000000";
    const result = /^rgba?\((\d+),\s*(\d+),\s*(\d+)/i.exec(rgb);
    return result ? "#" + [1, 2, 3].map(i => {
      const hex = parseInt(result[i]).toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    }).join("") : "#000000";
  }

  // Load existing game items
  async function loadGame() {
    if (!gameId) {
      alert("No gameId provided");
      return;
    }
    const ref = doc(db, "games", gameId);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      alert("Game not found");
      return;
    }
    const data = snap.data();
    if (!data.items) return;
    for (const item of data.items) {
      addItem(item.type, item.x, item.y, item.width, item.height, item);
    }
  }

  // Deselect items on clicking outside
  canvas.addEventListener("click", () => {
    selectedItem = null;
    colorPicker.style.display = "none";
    textInput.style.display = "none";
  });

  window.addEventListener("beforeunload", e => {
    if (unsavedChanges) {
      e.preventDefault();
      e.returnValue = "";
    }
  });

  loadGame();
</script>

</body>
</html>
