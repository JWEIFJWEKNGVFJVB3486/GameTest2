<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Game</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: "Comic Sans MS", cursive, sans-serif;
  }
  canvas {
    display: block;
    background: #eef;
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  .block {
    position: absolute;
    background: #3498db;
    border-radius: 4px;
    pointer-events: none;
  }
  #leaderboard {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px #ccc;
    font-size: 14px;
    max-height: 80vh;
    overflow-y: auto;
  }

  #chatInput {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-family: "Comic Sans MS", cursive, sans-serif;
    font-size: 16px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #aaa;
    display: none;
  }

  #mobileControls {
    position: absolute;
    bottom: 20px;
    left: 20px;
    display: flex;
    flex-wrap: wrap;
    width: 140px;
    gap: 10px;
    user-select: none;
    touch-action: none;
  }
  #chatButton {
    width: 40px;
    height: 40px;
    background: #4448;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    order: 5; /* To place it after arrows */
    margin-left: 10px;
  }

  .arrow-button {
    width: 40px;
    height: 40px;
    background: #4448;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }

  #arrowUp { order: 1; margin-left: 50px; }
  #arrowLeft { order: 2; margin-top: 10px; margin-right: 10px; }
  #arrowDown { order: 3; margin-left: 50px; }
  #arrowRight { order: 4; margin-top: 10px; margin-left: 10px; }

  #mobileControls {
    justify-content: center;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="gameArea"></div>

<div id="leaderboard">
  <strong>Players</strong>
  <br />
  <ul id="board"></ul>
</div>

<input id="chatInput" placeholder="Type your message..." maxlength="50" />

<div id="mobileControls" aria-label="Movement controls" role="group">
  <div id="chatButton" class="arrow-button" aria-label="Toggle chat">ðŸ’¬</div>
  <div id="arrowUp" class="arrow-button" aria-label="Move up">â–²</div>
  <div id="arrowLeft" class="arrow-button" aria-label="Move left">â—„</div>
  <div id="arrowDown" class="arrow-button" aria-label="Move down">â–¼</div>
  <div id="arrowRight" class="arrow-button" aria-label="Move right">â–º</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getDatabase, ref, set, onDisconnect, onChildAdded, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
  authDomain: "gametest2-ba5fe.firebaseapp.com",
  databaseURL: "https://gametest2-ba5fe-default-rtdb.firebaseio.com",
  projectId: "gametest2-ba5fe",
  storageBucket: "gametest2-ba5fe.firebasestorage.app",
  messagingSenderId: "1063979387642",
  appId: "1:1063979387642:web:307e4621ae0394bcb49743",
  measurementId: "G-394Y1PYWV7"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const firestore = getFirestore(app);
const realtimeDb = getDatabase(app);

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const board = document.getElementById("board");
const chatInput = document.getElementById("chatInput");
const chatButton = document.getElementById("chatButton");
const arrowUp = document.getElementById("arrowUp");
const arrowDown = document.getElementById("arrowDown");
const arrowLeft = document.getElementById("arrowLeft");
const arrowRight = document.getElementById("arrowRight");

let player = null;
let playerRef = null;
let players = {};
let keysPressed = {};
let chatVisible = false;
let items = [];
let hatImages = {};
let hatsMap = new Map();
let faceImages = {};

const urlParams = new URLSearchParams(window.location.search);
const gameId = urlParams.get('gameId');

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

async function loadHats() {
  const hatsCol = collection(firestore, "hats");
  const snapshot = await getDocs(hatsCol);
  snapshot.forEach(doc => {
    const data = doc.data();
    hatsMap.set(doc.id, data);
    if (data.imageUrl) {
      const img = new Image();
      img.src = data.imageUrl;
      hatImages[doc.id] = img;
    }
  });
}

async function fetchUserData(uid) {
  const docRef = doc(firestore, "users", uid);
  const snap = await getDoc(docRef);
  if (!snap.exists()) return null;

  const data = snap.data();

  if (data.equippedHat && !hatImages[uid]) {
    const hatImg = new Image();
    hatImg.src = data.equippedHat;
    hatImages[uid] = hatImg;
  }

  if (data.equippedFace && !faceImages[uid]) {
    const faceDoc = await getDoc(doc(firestore, "faces", data.equippedFace));
    if (faceDoc.exists()) {
      const faceImg = new Image();
      faceImg.src = faceDoc.data().imageUrl;
      faceImages[uid] = faceImg;
    }
  }

  return data;
}

function handlePlayerUpdate(id, data) {
  players[id] = {
    ...data,
    equippedHat: data.equippedHat || ""
  };

  fetchUserData(id).then(userData => {
    if (userData && players[id]) {
      players[id].equippedHat = userData.equippedHat || "";
    }
  });
}

async function loadBlocks() {
  if (!gameId) {
    console.error("No gameId in URL");
    items = [];
    return;
  }

  const gameDocRef = doc(firestore, "games", gameId);
  const gameSnap = await getDoc(gameDocRef);

  if (!gameSnap.exists()) {
    console.error("Game document not found");
    items = [];
    return;
  }

  const data = gameSnap.data();

  if (!data.items || !Array.isArray(data.items)) {
    console.error("No items array found in game document");
    items = [];
    return;
  }

  items = data.items.filter(item =>
    ["shape", "block", "circle", "text"].includes(item.type)
  );

  console.log("Blocks loaded:", items.length);
}

function updateLeaderboard() {
  board.innerHTML = "";

  // Sort players by score descending
  const sortedPlayers = Object.entries(players)
    .sort((a, b) => (b[1].score || 0) - (a[1].score || 0))
    .slice(0, 20);

  sortedPlayers.forEach(([id, data]) => {
    const li = document.createElement("li");
    li.textContent = `${data.username || "Anon"} - ${data.score || 0}`;
    board.appendChild(li);
  });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw all blocks (items)
  items.forEach(item => {
    if (item.type === "block" || item.type === "shape") {
      ctx.fillStyle = item.color || "#3498db";
      ctx.fillRect(item.x, item.y, item.width, item.height);
    } else if (item.type === "circle") {
      ctx.fillStyle = item.color || "#3498db";
      ctx.beginPath();
      ctx.arc(item.x, item.y, item.radius || 10, 0, Math.PI * 2);
      ctx.fill();
    } else if (item.type === "text") {
      ctx.font = "20px Comic Sans MS";
      ctx.fillStyle = item.color || "black";
      ctx.fillText(item.text || "", item.x, item.y);
    }
  });

  // Draw all players
  Object.entries(players).forEach(([id, p]) => {
    // Simple square for player
    ctx.fillStyle = id === player?.uid ? "#2ecc71" : "#e74c3c"; // green self, red others
    ctx.fillRect(p.x, p.y, 30, 50);

    // Draw hat if any
    if (p.equippedHat && hatImages[p.equippedHat]) {
      const hat = hatImages[p.equippedHat];
      ctx.drawImage(hat, p.x - 5, p.y - 20, 40, 30);
    }

    // Draw face if any
    if (faceImages[id]) {
      const face = faceImages[id];
      ctx.drawImage(face, p.x + 5, p.y + 10, 20, 20);
    }

    // Draw username above player
    ctx.font = "14px Comic Sans MS";
    ctx.fillStyle = "black";
    ctx.textAlign = "center";
    ctx.fillText(p.username || "Anon", p.x + 15, p.y - 10);
  });
}

function updatePlayerData() {
  if (!player || !playerRef) return;

  // Move player by keys pressed
  const speed = 4;
  if (keysPressed.ArrowUp || keysPressed.w) player.y -= speed;
  if (keysPressed.ArrowDown || keysPressed.s) player.y += speed;
  if (keysPressed.ArrowLeft || keysPressed.a) player.x -= speed;
  if (keysPressed.ArrowRight || keysPressed.d) player.x += speed;

  // Clamp inside canvas
  player.x = Math.max(0, Math.min(canvas.width - 30, player.x));
  player.y = Math.max(0, Math.min(canvas.height - 50, player.y));

  // Update Realtime Database
  set(playerRef, player).catch(console.error);
}

function loop() {
  updatePlayerData();
  draw();
  requestAnimationFrame(loop);
}

function setupKeyListeners() {
  window.addEventListener("keydown", e => {
    keysPressed[e.key] = true;

    // Prevent scrolling for arrows and space
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)) {
      e.preventDefault();
    }

    if (e.key === "Enter" && chatVisible) {
      submitChat();
    }
  });

  window.addEventListener("keyup", e => {
    keysPressed[e.key] = false;
  });
}

function submitChat() {
  if (!player || !playerRef) return;
  const text = chatInput.value.trim();
  if (!text) return;

  // Send chat message as part of player data (optional)
  // This example does not implement chat display, you can add if needed

  chatInput.value = "";
  chatInput.style.display = "none";
  chatVisible = false;
}

function setupMobileControls() {
  function toggleChat() {
    chatVisible = !chatVisible;
    chatInput.style.display = chatVisible ? "block" : "none";
    if (chatVisible) chatInput.focus();
  }

  chatButton.addEventListener("click", toggleChat);

  arrowUp.addEventListener("touchstart", e => { e.preventDefault(); keysPressed.ArrowUp = true; });
  arrowUp.addEventListener("touchend", e => { e.preventDefault(); keysPressed.ArrowUp = false; });

  arrowDown.addEventListener("touchstart", e => { e.preventDefault(); keysPressed.ArrowDown = true; });
  arrowDown.addEventListener("touchend", e => { e.preventDefault(); keysPressed.ArrowDown = false; });

  arrowLeft.addEventListener("touchstart", e => { e.preventDefault(); keysPressed.ArrowLeft = true; });
  arrowLeft.addEventListener("touchend", e => { e.preventDefault(); keysPressed.ArrowLeft = false; });

  arrowRight.addEventListener("touchstart", e => { e.preventDefault(); keysPressed.ArrowRight = true; });
  arrowRight.addEventListener("touchend", e => { e.preventDefault(); keysPressed.ArrowRight = false; });
}

async function init() {
  if (!gameId) {
    alert("No gameId specified in URL");
    return;
  }

  await loadHats();
  await loadBlocks();

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("Not logged in");
      return;
    }

    player = {
      uid: user.uid,
      username: user.displayName || "Anon",
      x: canvas.width / 2,
      y: canvas.height / 2,
      score: 0,
      equippedHat: "",
    };

    playerRef = ref(realtimeDb, `games/${gameId}/players/${player.uid}`);

    // Set initial data for this player
    set(playerRef, player).catch(console.error);

    // Remove player data on disconnect
    onDisconnect(playerRef).remove();

    // Listen for all players in this game
    const playersRef = ref(realtimeDb, `games/${gameId}/players`);

    onChildAdded(playersRef, snapshot => {
      const id = snapshot.key;
      const data = snapshot.val();
      handlePlayerUpdate(id, data);
      updateLeaderboard();
    });

    onChildChanged(playersRef, snapshot => {
      const id = snapshot.key;
      const data = snapshot.val();
      handlePlayerUpdate(id, data);
      updateLeaderboard();
    });

    onChildRemoved(playersRef, snapshot => {
      const id = snapshot.key;
      delete players[id];
      updateLeaderboard();
    });

    setupKeyListeners();
    setupMobileControls();

    loop();
  });
}

init();
</script>

</body>
</html>
