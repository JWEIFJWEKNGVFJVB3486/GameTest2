<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Page</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
      authDomain: "gametest2-ba5fe.firebaseapp.com",
      projectId: "gametest2-ba5fe",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserUid = null;
    let groupId = new URLSearchParams(window.location.search).get("id");
    let groupData = null;
    let userIsMember = false;
    let userIsOwner = false;

    const titleEl = document.getElementById("groupTitle");
    const bioEl = document.getElementById("groupBio");
    const bioInput = document.getElementById("bioInput");
    const updateBioBtn = document.getElementById("updateBioBtn");
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "/login.html";
      currentUserUid = user.uid;

      const groupDoc = await getDoc(doc(db, "groups", groupId));
      if (!groupDoc.exists()) return alert("Group not found");

      groupData = groupDoc.data();
      userIsMember = groupData.members?.includes(currentUserUid);
      userIsOwner = groupData.owner === currentUserUid;

      const ownerDoc = await getDoc(doc(db, "users", groupData.owner));
      const ownerName = ownerDoc.exists() ? (ownerDoc.data().username || "Unknown") : "Unknown";

      titleEl.textContent = `${groupData.name} (Leader: ${ownerName})`;
      bioEl.textContent = groupData.bio || "No bio yet.";
      bioInput.value = groupData.bio || "";

      if (!userIsOwner) {
        bioInput.style.display = "none";
        updateBioBtn.style.display = "none";
      }

      if (!userIsMember) {
        chatForm.style.display = "none";
        chatBox.innerHTML = "<p style='color:red;'>You must be a member to view or send messages.</p>";
      } else {
        loadMessages();
      }
    });

    updateBioBtn.onclick = async () => {
      const newBio = bioInput.value.trim();
      await updateDoc(doc(db, "groups", groupId), { bio: newBio });
      bioEl.textContent = newBio;
    };

    chatForm.onsubmit = async e => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      const userDoc = await getDoc(doc(db, "users", currentUserUid));
      const username = userDoc.exists() ? userDoc.data().username || "User" : "User";

      await addDoc(collection(db, "groups", groupId, "messages"), {
        text,
        sender: username,
        time: Date.now()
      });

      chatInput.value = "";
    };

    function loadMessages() {
      const q = query(collection(db, "groups", groupId, "messages"), orderBy("time"));
      onSnapshot(q, snapshot => {
        chatBox.innerHTML = "";
        snapshot.forEach(docSnap => {
          const msg = docSnap.data();
          const msgEl = document.createElement("div");
          msgEl.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text}`;
          chatBox.appendChild(msgEl);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }
  </script>

  <style>
    body {
      font-family: sans-serif;
      margin: 20px auto;
      max-width: 600px;
      background: #f0f0f0;
      padding: 20px;
      border-radius: 12px;
    }
    h2 { margin-bottom: 10px; }
    textarea {
      width: 100%;
      height: 60px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    #chatBox {
      border: 1px solid #ccc;
      padding: 10px;
      background: white;
      height: 300px;
      overflow-y: scroll;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    input[type="text"] {
      width: 80%;
      padding: 8px;
    }
    button {
      padding: 8px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h2 id="groupTitle">Loading...</h2>
  <p id="groupBio">Loading bio...</p>

  <textarea id="bioInput" placeholder="Edit bio..."></textarea>
  <button id="updateBioBtn">Update Bio</button>

  <h3>Group Chat</h3>
  <div id="chatBox">Loading messages...</div>

  <form id="chatForm">
    <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100" required />
    <button type="submit">Send</button>
  </form>
</body>
</html>
