<!DOCTYPE html>
<html>
<head>
  <title>All Games</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #eef5ff;
    }

    h1 {
      color: #333;
    }

    .game-item {
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .play-btn {
      background: #007bff;
      color: white;
      margin-top: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 6px;
      width: 400px;
    }
  </style>
</head>
<body>

<h1>All Games</h1>
<div id="gamesContainer"></div>

<div id="gameModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">Game Title</h2>
    <p id="modalDescription">Game Description</p>
    <p><strong>Created by:</strong> <span id="modalCreator">Creator</span></p>
    <p><strong>Visits:</strong> <span id="modalVisits">0</span></p>
    <div>
      <button id="likeBtn">üëç <span id="likeCount">0</span></button>
      <button id="dislikeBtn">üëé <span id="dislikeCount">0</span></button>
    </div>
    <h3>Comments</h3>
    <div id="commentsList"></div>
    <input id="commentInput" placeholder="Add a comment..." style="width:100%; margin-top:10px;">
    <button id="submitCommentBtn" class="play-btn">Post Comment</button>
    <br><br>
    <button id="modalPlayBtn" class="play-btn">Play Game</button>
    <button onclick="document.getElementById('gameModal').style.display='none'" class="play-btn">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, updateDoc, increment,
    onSnapshot, addDoc, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
    authDomain: "gametest2-ba5fe.firebaseapp.com",
    projectId: "gametest2-ba5fe",
    storageBucket: "gametest2-ba5fe.appspot.com",
    messagingSenderId: "1063979387642",
    appId: "1:1063979387642:web:307e4621ae0394bcb49743",
    measurementId: "G-394Y1PYWV7"
  };

  const app = initializeApp(firebaseConfig);
  const firestore = getFirestore(app);

  const gamesContainer = document.getElementById("gamesContainer");
  const modal = document.getElementById("gameModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalDescription = document.getElementById("modalDescription");
  const modalCreator = document.getElementById("modalCreator");
  const modalVisits = document.getElementById("modalVisits");
  const likeBtn = document.getElementById("likeBtn");
  const dislikeBtn = document.getElementById("dislikeBtn");
  const likeCount = document.getElementById("likeCount");
  const dislikeCount = document.getElementById("dislikeCount");
  const commentsList = document.getElementById("commentsList");
  const commentInput = document.getElementById("commentInput");
  const submitCommentBtn = document.getElementById("submitCommentBtn");
  const modalPlayBtn = document.getElementById("modalPlayBtn");

  let currentGameId = null;

  function escapeHTML(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  async function loadAllGames() {
    const snapshot = await getDocs(collection(firestore, "games"));
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "game-item";
      div.innerHTML = `
        <strong>${escapeHTML(data.name || "Unnamed Game")}</strong><br>
        <small>${escapeHTML(data.description || "No description provided.")}</small><br>
        <button class="play-btn">View</button>
      `;
      div.querySelector(".play-btn").addEventListener("click", () => openModal(docSnap.id));
      gamesContainer.appendChild(div);
    });
  }

  async function openModal(gameId) {
    currentGameId = gameId;
    const gameRef = doc(firestore, "games", gameId);
    await updateDoc(gameRef, { visits: increment(1) });
    const docSnap = await getDoc(gameRef);
    const data = docSnap.data();

    modalTitle.innerHTML = escapeHTML(data.name);
    modalDescription.innerHTML = escapeHTML(data.description);
    modalCreator.innerHTML = escapeHTML(data.creator);
    modalVisits.textContent = data.visits || 0;
    likeCount.textContent = data.likes || 0;
    dislikeCount.textContent = data.dislikes || 0;

    modalPlayBtn.onclick = () => {
      window.location.href = `play.html?gameId=${gameId}`;
    };

    likeBtn.onclick = async () => {
      await updateDoc(gameRef, { likes: increment(1) });
      likeCount.textContent = parseInt(likeCount.textContent) + 1;
    };

    dislikeBtn.onclick = async () => {
      await updateDoc(gameRef, { dislikes: increment(1) });
      dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
    };

    submitCommentBtn.onclick = async () => {
      const text = commentInput.value.trim();
      if (text === "") return;
      await addDoc(collection(firestore, "games", gameId, "comments"), {
        user: "Anonymous",
        text,
        timestamp: new Date()
      });
      commentInput.value = "";
    };

    const commentsRef = collection(firestore, "games", gameId, "comments");
    const q = query(commentsRef, orderBy("timestamp", "desc"));
    onSnapshot(q, snapshot => {
      commentsList.innerHTML = "";
      snapshot.forEach(doc => {
        const comment = doc.data();
        const p = document.createElement("p");
        p.innerHTML = `<strong>${escapeHTML(comment.user)}:</strong> ${escapeHTML(comment.text)}`;
        commentsList.appendChild(p);
      });
    });

    modal.style.display = "flex";
  }

  loadAllGames();
</script>

</body>
</html>
