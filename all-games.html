<!DOCTYPE html>
<html>
<head>
  <title>All Games</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #eef5ff;
    }

    h1 {
      color: #333;
    }

    .game-item {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 3px 7px rgba(0,0,0,0.15);
      cursor: pointer;
    }

    .play-btn, .like-btn, .dislike-btn {
      background: #007bff;
      color: white;
      margin-top: 10px;
      padding: 8px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .like-btn.active, .dislike-btn.active {
      background-color: #28a745;
    }

    .dislike-btn.active {
      background-color: #dc3545;
    }

    .game-panel {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .comment-box textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 14px;
    }

    .comment {
      background: #f4f4f4;
      padding: 10px;
      margin-top: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<h1>All Games</h1>
<div id="gamesContainer"></div>
<div id="gamePanel" class="game-panel" style="display: none;"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, increment, getDoc, onSnapshot, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCkjACpngpo9U96StM2Z1Y9Q7B3XtNSIQ0",
    authDomain: "gametest2-ba5fe.firebaseapp.com",
    projectId: "gametest2-ba5fe",
    storageBucket: "gametest2-ba5fe.appspot.com",
    messagingSenderId: "1063979387642",
    appId: "1:1063979387642:web:307e4621ae0394bcb49743",
    measurementId: "G-394Y1PYWV7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  const gamesContainer = document.getElementById("gamesContainer");
  const gamePanel = document.getElementById("gamePanel");

  function escapeHTML(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  let currentUser = null;
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
  });

  async function loadAllGames() {
    const snapshot = await getDocs(collection(db, "games"));
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "game-item";
      div.innerHTML = `<strong>${escapeHTML(data.name || "Unnamed Game")}</strong><br>
        <small>${escapeHTML(data.description || "No description provided.")}</small><br>
        <small>Visits: ${data.visits || 0}</small>`;

      div.addEventListener("click", () => openGamePanel(docSnap.id));
      gamesContainer.appendChild(div);
    });
  }

  async function openGamePanel(gameId) {
    const docRef = doc(db, "games", gameId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return;

    await updateDoc(docRef, { visits: increment(1) });

    const game = docSnap.data();
    gamePanel.style.display = "block";
    gamePanel.innerHTML = `
      <h2>${escapeHTML(game.name)}</h2>
      <p>${escapeHTML(game.description)}</p>
      <button class="play-btn" onclick="location.href='play.html?gameId=${gameId}'">Play Game</button>
      <br><br>
      <button class="like-btn" id="likeBtn">üëç Like (<span id="likeCount">${game.likes || 0}</span>)</button>
      <button class="dislike-btn" id="dislikeBtn">üëé Dislike (<span id="dislikeCount">${game.dislikes || 0}</span>)</button>
      <div class="comment-box">
        <textarea id="commentText" placeholder="Add a comment..."></textarea>
        <button onclick="addComment('${gameId}')" class="play-btn">Post Comment</button>
      </div>
      <div id="commentsSection"></div>
    `;

    const likeBtn = document.getElementById("likeBtn");
    const dislikeBtn = document.getElementById("dislikeBtn");

    const userDocRef = currentUser ? doc(db, `games/${gameId}/votes/${currentUser.uid}`) : null;

    if (userDocRef) {
      const voteSnap = await getDoc(userDocRef);
      const vote = voteSnap.exists() ? voteSnap.data().vote : null;

      if (vote === "like") likeBtn.classList.add("active");
      if (vote === "dislike") dislikeBtn.classList.add("active");

      likeBtn.onclick = async () => {
        if (!currentUser) return alert("Log in to vote");
        const newVote = likeBtn.classList.contains("active") ? null : "like";
        await handleVote(gameId, newVote);
        openGamePanel(gameId);
      };

      dislikeBtn.onclick = async () => {
        if (!currentUser) return alert("Log in to vote");
        const newVote = dislikeBtn.classList.contains("active") ? null : "dislike";
        await handleVote(gameId, newVote);
        openGamePanel(gameId);
      };
    }

    const commentsRef = collection(db, `games/${gameId}/comments`);
    onSnapshot(commentsRef, (snapshot) => {
      const section = document.getElementById("commentsSection");
      section.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `<strong>${escapeHTML(data.username || "Anonymous")}</strong><br>${escapeHTML(data.text)}`;
        section.appendChild(div);
      });
    });
  }

  window.addComment = async function(gameId) {
    const text = document.getElementById("commentText").value.trim();
    if (!text || !currentUser) return;

    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const username = userSnap.exists() ? userSnap.data().username : "User";

    await addDoc(collection(db, `games/${gameId}/comments`), {
      text,
      username,
      createdAt: new Date()
    });
    document.getElementById("commentText").value = "";
  };

  async function handleVote(gameId, voteType) {
    const voteRef = doc(db, `games/${gameId}/votes/${currentUser.uid}`);
    const gameRef = doc(db, "games", gameId);
    const prevVoteSnap = await getDoc(voteRef);
    const prevVote = prevVoteSnap.exists() ? prevVoteSnap.data().vote : null;

    const updates = {};
    if (prevVote === voteType) {
      updates[prevVote + "s"] = increment(-1);
      await updateDoc(voteRef, { vote: null });
    } else {
      if (prevVote) updates[prevVote + "s"] = increment(-1);
      if (voteType) updates[voteType + "s"] = increment(1);
      await setDoc(voteRef, { vote: voteType });
    }

    await updateDoc(gameRef, updates);
  }

  loadAllGames();
</script>

</body>
</html>
